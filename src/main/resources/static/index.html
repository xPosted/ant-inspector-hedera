<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>üêå Async Task Viewer</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Material Design for Bootstrap -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.css" rel="stylesheet"/>

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        body {
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        canvas#graph-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
        }

        .interactive-ant {
            width: 40px;
            height: 40px;
            object-fit: contain;
            transition: transform 0.3s ease-in-out;
        }

        .interactive-ant:hover {
            transform: scale(1.3) rotate(10deg);
        }

        .nav-link.animated-toggle {
            transition: all 0.3s ease-in-out;
        }

        .nav-link.animated-toggle:hover {
            transform: scale(1.05);
            font-weight: bold;
            color: #0d6efd;
        }
    </style>
</head>
<body class="bg-light py-5">

<canvas id="graph-bg"></canvas>

<!-- Fullscreen Loading Overlay -->
<div id="loadingOverlay" class="d-none">
    <div class="d-flex justify-content-center align-items-center vh-100 vw-100 position-fixed top-0 start-0 bg-white bg-opacity-75"
         style="z-index: 1050;">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 fw-bold text-primary">Processing...</p>
            <p class="fw-bold text-primary" id="overlayHillId" style="font-family: monospace; font-size: 1rem;"></p>
        </div>
    </div>
</div>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
    <div class="container">
        <a class="navbar-brand fw-bold text-primary" href="#">AntInspector</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/swagger-ui/index.html" target="_blank">Swagger</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showAbout()">About</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link animated-toggle" href="#" id="toggleFormLink" onclick="toggleForm()">View by Hill ID</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div style="margin-top: 80px;"></div>

<div class="container">
    <header class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary d-flex justify-content-center align-items-center gap-2">
            AntInspector
            <img src="https://as2.ftcdn.net/v2/jpg/00/74/85/15/1000_F_74851599_oFtj5xO89cCq0djY5WbA0VDixzyHS6F7.jpg"
                 alt="ant" class="interactive-ant"/>
        </h1>
        <h2 class="mb-4 text-secondary">For HEDERA (HBAR) accounts network</h2>
    </header>

    <!-- Main Form -->
    <form id="relationForm" class="card p-4 shadow-3">
        <div class="form-outline mb-3">
            <input type="text" name="sourceAccountId" id="sourceAccountId" class="form-control" required/>
            <label class="form-label" for="sourceAccountId">Source Account ID</label>
        </div>
        <div class="form-outline mb-3">
            <input type="text" name="targetAccountId" id="targetAccountId" class="form-control" required/>
            <label class="form-label" for="targetAccountId">Target Account ID</label>
        </div>
        <div class="form-outline mb-3">
            <input type="number" name="antCount" id="antCount" class="form-control" value="500" min="1"/>
            <label class="form-label" for="antCount">Ant Count</label>
        </div>
        <div class="form-outline mb-3">
            <input type="number" name="waves" id="waves" class="form-control" value="4" min="1"/>
            <label class="form-label" for="waves">Waves</label>
        </div>
        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" value="true" id="extendedResponse" name="extendedResponse"/>
            <label class="form-check-label" for="extendedResponse">Extended response</label>
        </div>
        <button type="submit" class="btn btn-primary btn-block">Start Task</button>
    </form>

    <!-- Hill ID Form -->
    <form id="hillIdForm" class="card p-4 shadow-3 d-none">
        <div class="form-outline mb-3">
            <input type="text" name="hillIdLookup" id="hillIdLookup" class="form-control" required/>
            <label class="form-label" for="hillIdLookup">Enter Hill ID</label>
        </div>
        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" value="true" id="extendedLookup" name="extendedLookup"/>
            <label class="form-check-label" for="extendedLookup">Extended response</label>
        </div>
        <button type="submit" class="btn btn-success btn-block">View Result</button>
    </form>

    <div class="card p-3 mt-3 shadow-sm d-none" id="hillIdDisplay">
        <h6>Task Hill ID:</h6>
        <div class="input-group">
            <input type="text" class="form-control" id="hillIdText" readonly>
            <button class="btn btn-outline-secondary" type="button" id="copyHillIdBtn" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy to clipboard">Copy</button>
        </div>
    </div>

    <div class="card p-4 mt-4 shadow-3 d-none" id="resultContainer">
        <button id="copyResultBtn" class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-3">
            Copy
        </button>
        <h5 class="text-success">Task Result</h5>
        <pre id="resultData" class="bg-light p-3 border rounded"></pre>
    </div>
</div>

<div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aboutModalLabel">About Hedera Relations</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="aboutContent">Loading...</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const form = document.getElementById("relationForm");
    const hillIdForm = document.getElementById("hillIdForm");
    const resultContainer = document.getElementById("resultContainer");
    const resultData = document.getElementById("resultData");
    const hillIdDisplay = document.getElementById("hillIdDisplay");
    const hillIdText = document.getElementById("hillIdText");
    const copyHillIdBtn = document.getElementById("copyHillIdBtn");

    const overlayHillId = document.getElementById("overlayHillId");

    function showOverlay(hillId = "") {
        document.getElementById("loadingOverlay").classList.remove("d-none");
        if (hillId) {
            overlayHillId.textContent = `Task Hill ID: ${hillId}`;
        } else {
            overlayHillId.textContent = "";
        }
    }

    function hideOverlay() {
        document.getElementById("loadingOverlay").classList.add("d-none");
        overlayHillId.textContent = "";
    }

    form.addEventListener("submit", async (event) => {
        event.preventDefault();
        showOverlay(); // No hillId yet on submit start
        resultContainer.classList.add("d-none");
        hillIdDisplay.classList.add("d-none");

        const formData = new FormData(form);
        const params = new URLSearchParams();
        for (const pair of formData.entries()) {
            params.append(pair[0], pair[1]);
        }

        const response = await fetch("/hedera/async/ant/run", {
            method: "POST",
            body: params
        });

        if (!response.ok) {
            let errorText;
            try {
                const err = await response.json();
                errorText = err.message || "Unknown error";
            } catch {
                errorText = await response.text();
            }
            hideOverlay();
            alert(`Error: ${response.status} ${errorText}`);
            return;
        }

        const asyncResponse = await response.json();
        hillIdText.value = asyncResponse.hillId;
        hillIdDisplay.classList.remove("d-none");

        // Now show overlay with hillId during polling
        showOverlay(asyncResponse.hillId);
        checkStatus(asyncResponse.hillId);
    });

    copyHillIdBtn.addEventListener("click", () => {
        hillIdText.select();
        hillIdText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(hillIdText.value).then(() => {
            copyHillIdBtn.textContent = "Copied!";
            setTimeout(() => (copyHillIdBtn.textContent = "Copy"), 2000);
        });
    });

    hillIdForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        resultContainer.classList.add("d-none");
        showOverlay();

        const hillId = document.getElementById("hillIdLookup").value;
        const extended = document.getElementById("extendedLookup").checked;

        const response = await fetch(`/hedera/async/ant/result?hillId=${hillId}&extended=${extended}`);
        if (!response.ok) {
            hideOverlay();
            alert(`Error fetching result: ${response.status}`);
            return;
        }

        const data = await response.json();
        resultData.textContent = JSON.stringify(data, null, 2);
        hideOverlay();
        resultContainer.classList.remove("d-none");
    });

    async function checkStatus(hillId) {
        const poll = async () => {
            const response = await fetch(`/hedera/async/ant/status?hillId=${hillId}`, { method: "POST" });
            if (!response.ok) {
                hideOverlay();
                alert("Error checking status");
                return;
            }
            const { status } = await response.json();

            if (status === "COMPLETED") {
                hideOverlay();
                fetchResult(hillId);
            } else if (status === "FAILED") {
                hideOverlay();
                alert("Task failed.");
            } else {
                // Keep showing overlay with hillId during polling
                showOverlay(hillId);
                setTimeout(poll, 2000);
            }
        };
        poll();
    }

    async function fetchResult(hillId) {
        const extended = document.getElementById("extendedResponse").checked;
        const response = await fetch(`/hedera/async/ant/result?hillId=${hillId}&extended=${extended}`);
        if (!response.ok) {
            alert("Failed to fetch result.");
            return;
        }
        const data = await response.json();
        resultData.textContent = JSON.stringify(data, null, 2);
        resultContainer.classList.remove("d-none");
    }

    async function showAbout() {
        const modal = new bootstrap.Modal(document.getElementById('aboutModal'));
        const content = document.getElementById("aboutContent");
        content.textContent = "Loading...";

        const response = await fetch("/hedera/about");
        if (response.ok) {
            const data = await response.json();

            content.innerHTML = `
          <strong>Version:</strong> ${data.VERSION}<br/>
          <strong>Name:</strong> ${data.NAME}<br/>
          <strong>Description:</strong><br/>
          <div style="white-space: pre-wrap; font-family: monospace; background-color: #f8f9fa; padding: 10px; border-radius: 5px;">
            ${data.DESCRIPTION || ""}
          </div>
          <strong>Contact Email:</strong> ${data.contactEmail}<br/>
          <strong>Contact Phone:</strong> ${data.contactPhone}<br/>
          <strong>Developed by:</strong> ${data.contactName}<br/>
          <strong>Github URL:</strong> ${data.GITHUB_URL}<br/>
          <strong>DB Ts From:</strong> ${data.timeFrom}<br/>
          <strong>DB Ts To:</strong> ${data.timeTo}<br/>
          <strong>Accounts Processed:</strong> ${data.accountsProcessed}<br/>
          <strong>Transactions Processed:</strong> ${data.transactionsProcessed}<br/>
          <strong>Storage Available:</strong> ${data.storageAvailable ? "Yes" : "No"}
        `;
        } else {
            content.textContent = "Failed to load system info.";
        }
        modal.show();
    }

    let hillFormActive = false;

    function toggleForm() {
        const toggleBtn = document.getElementById("toggleFormLink");

        if (!hillFormActive) {
            form.classList.add("animate__animated", "animate__fadeOut");
            setTimeout(() => {
                form.classList.add("d-none");
                form.classList.remove("animate__animated", "animate__fadeOut");
                hillIdForm.classList.remove("d-none");
                hillIdForm.classList.add("animate__animated", "animate__fadeIn");
            }, 500);
            toggleBtn.textContent = "New Task";
        } else {
            hillIdForm.classList.add("animate__animated", "animate__fadeOut");
            setTimeout(() => {
                hillIdForm.classList.add("d-none");
                hillIdForm.classList.remove("animate__animated", "animate__fadeOut");
                form.classList.remove("d-none");
                form.classList.add("animate__animated", "animate__fadeIn");
            }, 500);
            toggleBtn.textContent = "View by Hill ID";
        }

        hillFormActive = !hillFormActive;
    }

    const canvas = document.getElementById('graph-bg');
    const ctx = canvas.getContext('2d');
    let width, height;
    let points = [];

    function resizeCanvas() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        generatePoints();
    }

    function generatePoints() {
        points = [];
        for (let i = 0; i < 100; i++) {
            points.push({
                x: Math.random() * width,
                y: Math.random() * height,
                vx: (Math.random() - 0.5) * 0.5,
                vy: (Math.random() - 0.5) * 0.5
            });
        }
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);

        for (let p of points) {
            p.x += p.vx;
            p.y += p.vy;

            if (p.x < 0 || p.x > width) p.vx *= -1;
            if (p.y < 0 || p.y > height) p.vy *= -1;

            ctx.beginPath();
            ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
            ctx.fillStyle = '#2f80ed';
            ctx.fill();

            for (let q of points) {
                const dx = p.x - q.x;
                const dy = p.y - q.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 100) {
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(q.x, q.y);
                    ctx.strokeStyle = 'rgba(47, 128, 237, 0.2)';
                    ctx.stroke();
                }
            }
        }
        requestAnimationFrame(draw);
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    draw();
</script>
</body>
</html>
